<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>basic</title>
	<script type="text/javascript" src="../lib/seqdiag/parser.js" ></script>
</head>
<body style="background-color: #999999;">
	<script type="text/x-seqdiag" id="seqdiag-text">
		seqdiag {
			A;
			B;
			C;

			A -> B;
			B -> C;
			C --> B;
			B --> A;
		}
	</script>

	<div id="seqdiag"></div>

	<script type="text/javascript">
		var svgns = "http://www.w3.org/2000/svg";
		function createNode(stmt, x)
		{
			var rect = document.createElementNS(svgns, "rect");
			rect.setAttribute("id", "rect-" + stmt[1].id);
			rect.setAttribute("x", x);
			rect.setAttribute("width", 200);
			rect.setAttribute("y", 20);
			rect.setAttribute("height", 50);
			rect.setAttribute("fill", "#ffffff");
			rect.setAttribute("stroke", "#000000");
			var textbox = document.createElementNS(svgns, "text");
			textbox.setAttribute("id", "textbox-" + stmt[1].id);
			textbox.setAttribute("x", x + 100);
			textbox.setAttribute("y", 50);
			textbox.textContent = stmt[1].id;

			return [rect, textbox];
		}
		var target = document.getElementById('seqdiag-text');
		var inplace = document.getElementById('seqdiag');

		var AST = SeqdiagParser.parse(target.innerText);

		var svg = document.createElementNS(svgns, "svg");
		// svg.setAttribute("width", 600);
		// svg.setAttribute("hegith", 600);
		var start_x = 0;
		var start_y = 100;
		for (var i=0; i < AST[1].stmt.length; i++ ) {
			var stmt = AST[1].stmt[i];
			switch (stmt[0]) {
				case "node":
					var node = createNode(stmt, start_x);
					svg.appendChild(node[0]);
					svg.appendChild(node[1]);
					start_x += 200 + 50;
					break;
				case "edge":
					var path = document.createElementNS(svgns, "path");
					var left = svg.getElementById('rect-' + stmt[2]);
					var right = svg.getElementById('rect-' + stmt[3]);
					var lx = parseInt(left.getAttribute('x')) + ( parseInt(left.getAttribute('width')) / 2.0 );
					var rx = parseInt(right.getAttribute('x')) + ( parseInt(right.getAttribute('width')) / 2.0 );
					path.setAttribute("d", "M  " + lx + " " + start_y + " L " + rx + " " + start_y);
					path.setAttribute("stroke", "#000000");
					console.log([left, right]);
					svg.appendChild(path);
					start_y += 100;
					break;
				default:
					break;
			}
			console.log(stmt);
		}
		var figure = document.createElement("figure");
		var caption = document.createElement("figcaption");
		caption.innerText = target.innerText;
		// figure.appendChild(caption);
		figure.appendChild(svg);
		inplace.appendChild(figure);
	</script>
</body>
</html>
